{% extends 'base.html' %}
{% load static %}

{% block title %}Explore - Golden Trash{% endblock %}

{% block extra_css %}
<style>
    .explore-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .explore-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .explore-header h1 {
        color: #2c5530;
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 32px;
    }

    .explore-header p {
        color: #666;
        font-size: 16px;
        margin-bottom: 20px;
    }

    .filter-tabs {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .filter-tab {
        padding: 8px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        background: white;
        color: #666;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .filter-tab:hover,
    .filter-tab.active {
        border-color: #4CAF50;
        background: #4CAF50;
        color: white;
        text-decoration: none;
    }

    .content-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .content-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f5f5f5;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .content-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .content-media {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .content-item:hover .content-media {
        transform: scale(1.05);
    }

    .content-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            45deg,
            rgba(76, 175, 80, 0.8),
            rgba(46, 125, 50, 0.8)
        );
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: all 0.3s ease;
        color: white;
        text-align: center;
        padding: 20px;
    }

    .content-item:hover .content-overlay {
        opacity: 1;
    }

    .content-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        font-size: 14px;
        font-weight: 600;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .content-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
        line-height: 1.2;
    }

    .content-category {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        background: rgba(255,255,255,0.2);
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 10px;
    }

    .content-author {
        font-size: 13px;
        opacity: 0.9;
    }

    .media-type-icon {
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(0,0,0,0.6);
        color: white;
        padding: 8px;
        border-radius: 50%;
        font-size: 16px;
        z-index: 2;
    }

    .load-more {
        text-align: center;
        margin-top: 40px;
    }

    .btn-load-more {
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .btn-load-more:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }

    .no-content {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }

    .no-content i {
        font-size: 64px;
        color: #ddd;
        margin-bottom: 20px;
    }

    .no-content h3 {
        color: #999;
        margin-bottom: 10px;
    }

    /* Modal styles */
    .content-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    }

    .content-modal.show {
        display: flex;
    }

    .modal-content {
        max-width: 90vw;
        max-height: 90vh;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        position: relative;
    }

    .modal-media {
        flex: 1;
        max-width: 60%;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-media img,
    .modal-media video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .modal-info {
        width: 400px;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .modal-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #4CAF50;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }

    .modal-user-info h4 {
        margin: 0;
        font-size: 16px;
        color: #333;
    }

    .modal-user-info p {
        margin: 0;
        font-size: 12px;
        color: #666;
    }

    .modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        z-index: 10;
    }

    .modal-caption {
        margin-bottom: 15px;
    }

    .modal-caption h5 {
        margin-bottom: 8px;
        color: #333;
    }

    .modal-caption p {
        color: #666;
        line-height: 1.5;
        margin: 0;
    }

    .modal-meta {
        margin-bottom: 15px;
    }

    .meta-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .meta-label {
        color: #666;
        font-weight: 500;
    }

    .meta-value {
        color: #333;
    }

    .modal-hashtags {
        margin-bottom: 15px;
    }

    .hashtag {
        display: inline-block;
        background: #e8f5e8;
        color: #2c5530;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        margin: 2px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .explore-container {
            padding: 15px;
        }

        .content-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .explore-header h1 {
            font-size: 24px;
        }

        .filter-tabs {
            gap: 10px;
        }

        .filter-tab {
            padding: 6px 15px;
            font-size: 14px;
        }

        .modal-content {
            flex-direction: column;
            max-width: 95vw;
            max-height: 95vh;
        }

        .modal-media {
            max-width: 100%;
            height: 60vh;
        }

        .modal-info {
            width: 100%;
            max-height: 35vh;
            overflow-y: auto;
        }
    }

    @media (max-width: 480px) {
        .content-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .content-overlay {
            padding: 15px;
        }

        .content-title {
            font-size: 14px;
        }

        .content-stats {
            font-size: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="explore-container">
    <div class="explore-header">
        <h1><i class="fas fa-compass"></i> Explore</h1>
        <p>Discover amazing waste transformation projects from our community</p>
        
        <div class="filter-tabs">
            <a href="#" class="filter-tab active" data-filter="all">All</a>
            <a href="#" class="filter-tab" data-filter="image">Images</a>
            <a href="#" class="filter-tab" data-filter="video">Videos</a>
            <a href="#" class="filter-tab" data-filter="organic">Organic</a>
            <a href="#" class="filter-tab" data-filter="plastic">Plastic</a>
            <a href="#" class="filter-tab" data-filter="paper">Paper</a>
            <a href="#" class="filter-tab" data-filter="metal">Metal</a>
            <a href="#" class="filter-tab" data-filter="glass">Glass</a>
        </div>
    </div>

    <div class="content-grid" id="contentGrid">
        <!-- Sample content items - these would be populated from database -->
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const filterTabs = document.querySelectorAll('.filter-tab');
    const contentItems = document.querySelectorAll('.content-item');

    filterTabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active tab
            filterTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            
            // Filter content items
            contentItems.forEach(item => {
                if (filter === 'all') {
                    item.style.display = 'block';
                } else if (filter === 'image' || filter === 'video') {
                    item.style.display = item.dataset.type === filter ? 'block' : 'none';
                } else {
                    item.style.display = item.dataset.category === filter ? 'block' : 'none';
                }
            });
        });
    });
});



function openModal(contentId) {
    const modal = document.getElementById('contentModal');
    const data = contentData[contentId];
    
    if (!data) return;
    
    // Update modal content
    document.getElementById('modalMedia').innerHTML = data.type === 'video' 
        ? `<video controls style="max-width: 100%; max-height: 100%;"><source src="${data.src}" type="video/mp4">Your browser does not support the video tag.</video>`
        : `<img src="${data.src}" alt="${data.title}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
    
    document.getElementById('modalAvatar').textContent = data.avatar;
    document.getElementById('modalUsername').textContent = data.username;
    document.getElementById('modalDate').textContent = data.date;
    document.getElementById('modalCaptionText').textContent = data.caption;
    document.getElementById('modalCategory').textContent = data.category;
    document.getElementById('modalDuration').textContent = data.duration;
    document.getElementById('modalMaterials').textContent = data.materials;
    document.getElementById('modalLikes').textContent = data.likes;
    document.getElementById('modalComments').textContent = data.comments;
    
    // Update hashtags
    const hashtagsContainer = document.querySelector('.modal-hashtags');
    hashtagsContainer.innerHTML = data.hashtags.map(tag => 
        `<span class="hashtag">${tag}</span>`
    ).join('');
    
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeModal(event) {
    if (event && event.target !== event.currentTarget && !event.target.classList.contains('modal-close')) {
        return;
    }
    
    const modal = document.getElementById('contentModal');
    modal.classList.remove('show');
    document.body.style.overflow = 'auto';
}

function loadMoreContent() {
    // Simulate loading more content
    const btn = document.querySelector('.btn-load-more');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    btn.disabled = true;
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        // You could add more content items here
        alert('More content loaded! (This is a demo)');
    }, 2000);
}

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});

// Intersection Observer for lazy loading
const observerOptions = {
    root: null,
    rootMargin: '50px',
    threshold: 0.1
};

const imageObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const img = entry.target;
            if (img.dataset.src) {
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
                imageObserver.unobserve(img);
            }
        }
    });
}, observerOptions);

// Initialize lazy loading for images
document.addEventListener('DOMContentLoaded', function() {
    const lazyImages = document.querySelectorAll('img[data-src]');
    lazyImages.forEach(img => imageObserver.observe(img));
});

// Like functionality
function toggleLike(contentId, element) {
    const likeCount = element.querySelector('span');
    const currentCount = parseInt(likeCount.textContent);
    const icon = element.querySelector('i');
    
    if (icon.classList.contains('fas')) {
        // Unlike
        icon.classList.remove('fas');
        icon.classList.add('far');
        likeCount.textContent = currentCount - 1;
        element.classList.remove('liked');
    } else {
        // Like
        icon.classList.remove('far');
        icon.classList.add('fas');
        likeCount.textContent = currentCount + 1;
        element.classList.add('liked');
        
        // Add animation
        element.style.transform = 'scale(1.2)';
        setTimeout(() => {
            element.style.transform = 'scale(1)';
        }, 200);
    }
    
    // Send like/unlike request to backend
    // fetch(`/api/content/${contentId}/like/`, {
    //     method: 'POST',
    //     headers: {
    //         'Content-Type': 'application/json',
    //         'X-CSRFToken': getCookie('csrftoken')
    //     }
    // });
}

// Share functionality
function shareContent(contentId) {
    const data = contentData[contentId];
    if (!data) return;
    
    if (navigator.share) {
        navigator.share({
            title: data.title,
            text: data.caption,
            url: window.location.href + `#content-${contentId}`
        }).catch(console.error);
    } else {
        // Fallback: copy link to clipboard
        const url = window.location.href + `#content-${contentId}`;
        navigator.clipboard.writeText(url).then(() => {
            showNotification('Link copied to clipboard!');
        }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = url;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showNotification('Link copied to clipboard!');
        });
    }
}

// Show notification
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
    `;
    
    // Add notification styles if not already present
    if (!document.querySelector('#notification-styles')) {
        const styles = document.createElement('style');
        styles.id = 'notification-styles';
        styles.textContent = `
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                border-radius: 8px;
                padding: 12px 16px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 8px;
                z-index: 2000;
                transform: translateX(400px);
                transition: transform 0.3s ease;
            }
            .notification.show {
                transform: translateX(0);
            }
            .notification-success {
                border-left: 4px solid #4CAF50;
                color: #2c5530;
            }
            .notification-error {
                border-left: 4px solid #f44336;
                color: #c62828;
            }
        `;
        document.head.appendChild(styles);
    }
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => notification.classList.add('show'), 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Search functionality
function initializeSearch() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput) return;
    
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = this.value.toLowerCase().trim();
            filterContentBySearch(query);
        }, 300);
    });
}

function filterContentBySearch(query) {
    const contentItems = document.querySelectorAll('.content-item');
    
    contentItems.forEach(item => {
        const title = item.querySelector('.content-title')?.textContent.toLowerCase() || '';
        const author = item.querySelector('.content-author')?.textContent.toLowerCase() || '';
        const category = item.dataset.category?.toLowerCase() || '';
        
        const matches = title.includes(query) || 
                       author.includes(query) || 
                       category.includes(query);
        
        item.style.display = matches || query === '' ? 'block' : 'none';
    });
    
    // Show no results message if needed
    const visibleItems = document.querySelectorAll('.content-item[style*="block"], .content-item:not([style])');
    const noResultsMessage = document.getElementById('noResults');
    
    if (visibleItems.length === 0 && query !== '') {
        if (!noResultsMessage) {
            const message = document.createElement('div');
            message.id = 'noResults';
            message.className = 'no-content';
            message.innerHTML = `
                <i class="fas fa-search"></i>
                <h3>No results found</h3>
                <p>Try adjusting your search terms or filters</p>
            `;
            document.getElementById('contentGrid').appendChild(message);
        }
    } else if (noResultsMessage) {
        noResultsMessage.remove();
    }
}

// Infinite scroll
function initializeInfiniteScroll() {
    let loading = false;
    let page = 1;
    
    window.addEventListener('scroll', () => {
        if (loading) return;
        
        const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
        
        if (scrollTop + clientHeight >= scrollHeight - 1000) {
            loading = true;
            loadMoreContent(page + 1).then(() => {
                page++;
                loading = false;
            });
        }
    });
}

// Enhanced load more function
async function loadMoreContent(pageNum = null) {
    const btn = document.querySelector('.btn-load-more');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    btn.disabled = true;
    
    try {
        // Simulate API call
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // In a real app, you would fetch data from your API here
        // const response = await fetch(`/api/explore/?page=${pageNum || 2}`);
        // const data = await response.json();
        
        // For demo, we'll just show a message
        showNotification('More content loaded!');
        
        // You could add new content items to the grid here
        // addContentItems(data.results);
        
    } catch (error) {
        console.error('Error loading content:', error);
        showNotification('Failed to load more content', 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Get CSRF token for Django
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize all functionality when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeSearch();
    initializeInfiniteScroll();
    
    // Add smooth scrolling to top button
    const scrollTopBtn = document.createElement('button');
    scrollTopBtn.className = 'scroll-to-top';
    scrollTopBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
    scrollTopBtn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Add scroll to top button styles
    const scrollTopStyles = document.createElement('style');
    scrollTopStyles.textContent = `
        .scroll-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #4CAF50;
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        .scroll-to-top.show {
            opacity: 1;
            visibility: visible;
        }
        .scroll-to-top:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
        }
    `;
    document.head.appendChild(scrollTopStyles);
    document.body.appendChild(scrollTopBtn);
    
    // Show/hide scroll to top button
    window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) {
            scrollTopBtn.classList.add('show');
        } else {
            scrollTopBtn.classList.remove('show');
        }
    });
});
</script>
{% endblock %}