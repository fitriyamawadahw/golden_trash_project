{% extends "base.html" %}

{% block title %}Explore{% endblock %}

{% block content %}
<style>
  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }
  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 20px;
  }
  .product-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    background: #fff;
    cursor: pointer;
  }
  .product-card img {
    width: 100%;
    display: block;
  }
  .product-card h3 {
    font-size: 1rem;
    padding: 10px;
    margin: 0;
    text-align: center;
  }

  /* Modal Styles */
  #modal {
    display: none;
    position: fixed;
    z-index: 100;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
  }
  #modal.active {
    display: flex;
  }
  #modal-content {
    background: white;
    border-radius: 8px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    padding: 20px;
    position: relative;
  }
  #modal-close {
    position: absolute;
    right: 15px;
    top: 10px;
    cursor: pointer;
    font-size: 20px;
  }

  #modal img {
    max-width: 100%;
    border-radius: 8px;
  }

  #like-btn {
    background: #3897f0;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 10px;
  }
  #like-btn.liked {
    background: #ed4956;
  }

  #comments-section {
    margin-top: 20px;
  }
  #comments-list > div {
    border-bottom: 1px solid #ddd;
    padding: 8px 0;
  }
  #comment-input {
    width: 100%;
    box-sizing: border-box;
    padding: 8px;
    margin-top: 10px;
  }
  #submit-comment {
    margin-top: 5px;
    padding: 8px 15px;
    background: #3897f0;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 4px;
  }
</style>

<div class="container">
  <h1>Explore Random Products</h1>
  {% if products %}
  <div class="products-grid">
    {% for product in products %}
      <div class="product-card" data-id="{{ product.id }}">
        {% if product.image %}
          <img src="{{ product.image.url }}" alt="{{ product.title }}">
        {% else %}
          <div style="height: 180px; display:flex; align-items:center; justify-content:center; background:#eee;">No Image</div>
        {% endif %}
        <h3>{{ product.title }}</h3>
      </div>
    {% endfor %}
  </div>
  {% else %}
    <p>No products found.</p>
  {% endif %}
</div>

<!-- Modal -->
<div id="modal">
  <div id="modal-content">
    <span id="modal-close">&times;</span>
    <h2 id="modal-title"></h2>
    <img id="modal-image" src="" alt="">
    <p id="modal-cara"></p>
    <button id="like-btn">Like (<span id="like-count">0</span>)</button>

    <div id="comments-section">
      <h3>Comments</h3>
      <div id="comments-list"></div>
      <textarea id="comment-input" placeholder="Add a comment"></textarea>
      <button id="submit-comment">Submit</button>
    </div>
  </div>
</div>

<script>
// Modal controls
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modal-content');
const modalClose = document.getElementById('modal-close');
const modalTitle = document.getElementById('modal-title');
const modalImage = document.getElementById('modal-image');
const modalCara = document.getElementById('modal-cara');
const likeBtn = document.getElementById('like-btn');
const likeCount = document.getElementById('like-count');
const commentsList = document.getElementById('comments-list');
const commentInput = document.getElementById('comment-input');
const submitComment = document.getElementById('submit-comment');

let currentProductId = null;
let liked = false;

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for(let i=0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if(cookie.substring(0, name.length+1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length+1));
        break;
      }
    }
  }
  return cookieValue;
}

function loadComments(postId) {
  commentsList.innerHTML = '<p>Loading comments...</p>';
  fetch(`/explore/api/post/${postId}/comments/`)
    .then(res => res.json())
    .then(data => {
      if(data.comments.length === 0){
        commentsList.innerHTML = '<p>No comments yet.</p>';
      } else {
        commentsList.innerHTML = '';
        data.comments.forEach(c => {
          const div = document.createElement('div');
          div.innerHTML = `<strong>${c.author}</strong> <small>${c.created_at}</small><br>${c.text}`;
          commentsList.appendChild(div);
        });
      }
    });
}

submitComment.addEventListener('click', () => {
  const text = commentInput.value.trim();
  if (!text) {
    alert('Comment cannot be empty');
    return;
  }
  fetch(`/explore/api/post/${currentProductId}/comments/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({text})
  })
  .then(res => {
    if(!res.ok) throw new Error('Failed to submit comment');
    return res.json();
  })
  .then(newComment => {
    commentInput.value = '';
    const div = document.createElement('div');
    div.innerHTML = `<strong>${newComment.author}</strong> <small>${newComment.created_at}</small><br>${newComment.text}`;
    commentsList.insertBefore(div, commentsList.firstChild);
  })
  .catch(e => alert(e.message));
});

likeBtn.addEventListener('click', () => {
  const action = liked ? 'unlike' : 'like';
  fetch(`/explore/api/post/${currentProductId}/like/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: `action=${action}`
  })
  .then(res => {
    if (!res.ok) throw new Error('Failed to toggle like');
    return res.json();
  })
  .then(data => {
    likeCount.textContent = data.likes;
    liked = !liked;
    likeBtn.classList.toggle('liked', liked);
  })
  .catch(e => alert(e.message));
});

function openModal(productId) {
  currentProductId = productId;
  modal.classList.add('active');
  modalTitle.textContent = 'Loading...';
  modalImage.src = '';
  modalCara.textContent = '';
  likeCount.textContent = '0';
  liked = false;
  likeBtn.classList.remove('liked');
  commentsList.innerHTML = '<p>Loading comments...</p>';

  fetch(`/explore/api/post/${productId}/`)
    .then(res => res.json())
    .then(data => {
      modalTitle.textContent = data.title;
      modalImage.src = data.image;
      modalCara.textContent = `Cara Pembuatan: ${data.cara_pembuatan}`;
      likeCount.textContent = data.likes;
      // Reset liked state (improve later by saving like state per user)
    });

  loadComments(productId);
}

modalClose.onclick = () => {
  modal.classList.remove('active');
};

window.onclick = function(event) {
  if(event.target == modal) {
    modal.classList.remove('active');
  }
};

document.querySelectorAll('.product-card').forEach(card => {
  card.addEventListener('click', () => {
    const postId = card.getAttribute('data-id');
    openModal(postId);
  });
});
</script>
{% endblock %}
